// 스키마: sql/migration/init.sql, sql/migration/20250128_code_category_and_code.sql 과 동기화
// 컬럼 주석(note)은 init.sql의 COMMENT ON COLUMN 문구와 동일

Table code_category {
  code varchar(40) [pk, not null, note: "공통코드 분류 식별자"]
  is_sealed boolean [not null, default: false, note: "해당 분류 내 코드 수정/추가 가능 여부"]
  name varchar(50) [not null, note: "공통코드 분류 명"]
  description text [note: "분류 설명"]
  note text [note: "비고"]
  created_at timestamp [not null, default: `now()`, note: "생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시 (소프트 삭제)"]
}

Table code {
  category_code varchar(40) [not null, note: "공통코드 분류 코드"]
  code varchar(40) [not null, note: "공통코드 값"]
  name varchar(50) [not null, note: "공통코드 명"]
  value text [note: "코드에 매핑되는 값"]
  description text [note: "코드 설명"]
  note text [note: "비고"]
  order int [not null, default: 0, note: "정렬 순서"]
  upper_category_code varchar(40) [note: "상위 코드 분류 (upper_code와 함께 null이거나 함께 사용)"]
  upper_code varchar(40) [note: "상위 코드 값 (upper_category_code와 함께 null이거나 함께 사용)"]
  created_at timestamp [not null, default: `now()`, note: "생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]

  indexes {
    (category_code, code) [pk]
  }
}

Table board {
  id uuid [pk, not null, note: "게시판 고유 ID"]
  menu_code varchar(40) [note: "연결된 메뉴 코드"]
  type_category_code varchar(40) [not null, default: 'board_type', note: "게시판 타입 분류 코드 (board_type)"]
  type varchar(40) [not null, default: 'project', note: "게시판 타입 코드 값"]
  name varchar(50) [not null, note: "게시판 명"]
  description text [note: "게시판 설명"]
  note text [note: "비고"]
  is_public boolean [not null, default: true, note: "게시판 공개 여부"]
  order int [not null, default: 0, note: "게시판 정렬 순서"]
  created_at timestamp [not null, default: `now()`, note: "생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
}

Table topic {
  id uuid [pk, not null, note: "게시글 고유 ID"]
  author_user_id uuid [not null, note: "게시글 작성자 ID"]
  menu_code varchar(40) [note: "연결된 메뉴 코드"]
  status_category_code varchar(40) [not null, default: 'topic_status', note: "게시글 상태 분류 코드"]
  status varchar(40) [not null, default: 'created', note: "게시글 상태 코드 값"]
  board_id uuid [not null, note: "소속 게시판 ID"]
  title varchar(200) [not null, note: "게시글 제목"]
  content text [not null, note: "게시글 본문"]
  is_notice boolean [not null, default: false, note: "공지글 여부"]
  is_pinned boolean [not null, default: false, note: "상단 고정 여부"]
  is_public boolean [not null, default: true, note: "공개 여부"]
  view_count int [not null, default: 0, note: "조회수"]
  published_at timestamp [note: "게시글 공개 예정 시각"]
  created_at timestamp [not null, default: `now()`, note: "작성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
}

Table common_file {
  id uuid [pk, not null, note: "파일 고유 ID"]
  session_id varchar(64) [note: "임시 업로드 세션 ID"]
  original_name varchar(255) [not null, note: "원본 파일명"]
  stored_name varchar(255) [not null, note: "서버 저장 파일명"]
  file_path text [not null, note: "파일 저장 경로"]
  file_size bigint [not null, note: "파일 크기 (byte)"]
  mime_type varchar(100) [not null, note: "파일 MIME 타입"]
  file_ext varchar(20) [note: "파일 확장자"]
  created_at timestamp [not null, default: `now()`, note: "업로드 일시"]
}

Table rel__topic_file {
  id uuid [pk, not null, note: "게시글-파일 연결 ID"]
  topic_id uuid [not null, note: "게시글 ID"]
  file_id uuid [not null, note: "파일 ID"]
  order int [not null, default: 0, note: "게시글 내 파일 정렬 순서"]
  is_main boolean [not null, default: false, note: "대표 파일 여부"]
  created_at timestamp [not null, default: `now()`, note: "연결 생성일시"]
}

Table rel__user_file {
  id uuid [pk, not null, note: "사용자-파일 연결 ID"]
  user_id uuid [not null, note: "사용자 ID"]
  file_id uuid [not null, note: "파일 ID"]
  usage varchar(40) [note: "파일 사용 목적 (PROFILE, COVER 등)"]
  is_main boolean [not null, default: true, note: "대표 이미지 여부"]
  created_at timestamp [not null, default: `now()`, note: "연결 생성일시"]
}

Table menu {
  code varchar(40) [pk, not null, note: "메뉴 코드"]
  name varchar(50) [not null, note: "메뉴 명"]
  description text [note: "메뉴 설명"]
  is_active boolean [not null, default: true, note: "메뉴 활성 여부"]
  is_admin boolean [not null, default: false, note: "관리자 전용 메뉴 여부"]
  order int [not null, default: 0, note: "메뉴 정렬 순서"]
  upper_code varchar(40) [note: "상위 메뉴 코드"]
  created_at timestamp [not null, default: `now()`, note: "생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
}

Table user {
  id uuid [pk, not null, note: "사용자 고유 ID"]
  role_category_code varchar(40) [not null, default: 'role', note: "권한 분류 코드"]
  role varchar(40) [not null, default: 'user', note: "권한 코드 값"]
  username varchar(50) [not null, unique, note: "로그인 아이디"]
  password varchar(256) [not null, note: "비밀번호 해시"]
  salt varchar(16) [not null, note: "비밀번호 해시 솔트"]
  email varchar(256) [not null, unique, note: "이메일"]
  name varchar(20) [not null, note: "사용자 실명"]
  nickname varchar(20) [not null, note: "닉네임"]
  is_active boolean [not null, default: true, note: "계정 활성 여부"]
  is_locked boolean [not null, default: false, note: "계정 잠금 여부"]
  created_at timestamp [not null, default: `now()`, note: "생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
}

Table user_auth_count {
  id uuid [pk, not null, note: "인증 시도 카운트 ID"]
  user_id uuid [note: "사용자 ID"]
  email varchar(256) [not null, note: "이메일 (비정규화)"]
  type_category_code varchar(40) [not null, default: 'user_auth_count_type', note: "인증 시도 유형 분류 코드"]
  type varchar(40) [not null, note: "인증 시도 유형 코드"]
  count integer [not null, default: 0, note: "시도 횟수"]
  created_at timestamp [not null, default: `now()`, note: "생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
  expired_at timestamp [note: "만료 일시"]
}

Table verification {
  id uuid [pk, not null, note: "인증 정보 ID"]
  user_id uuid [note: "사용자 ID"]
  session_id uuid [note: "세션 ID"]
  type_category_code varchar(40) [not null, default: 'verification_type', note: "인증 유형 분류 코드"]
  type varchar(40) [not null, note: "인증 유형 코드"]
  email varchar(256) [not null, note: "인증 대상 이메일"]
  code varchar(50) [not null, note: "인증 코드"]
  is_verified boolean [not null, default: false, note: "인증 완료 여부"]
  is_sent boolean [not null, default: false, note: "인증 메일 발송 여부"]
  created_at timestamp [not null, default: `now()`, note: "생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
  expired_at timestamp [note: "만료 일시"]
}

Table user_session {
  id uuid [pk, not null, note: "세션 ID"]
  user_id uuid [not null, note: "사용자 ID"]
  refresh_token varchar(512) [not null, note: "리프레시 토큰"]
  user_agent varchar(255) [note: "브라우저/디바이스 정보"]
  ip_address varchar(45) [note: "접속 IP (IPv4/IPv6)"]
  is_revoked boolean [not null, default: false, note: "강제 만료 여부"]
  created_at timestamp [not null, default: `now()`, note: "생성일"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
  expired_at timestamp [not null, note: "만료일"]
}

Table audit_log {
  id uuid [pk, not null, note: "감사 로그 ID"]
  target_type varchar(40) [not null, note: "대상 타입 (USER, TOPIC, CODE 등)"]
  target_id uuid [note: "대상 ID (nullable 허용)"]
  action varchar(40) [not null, note: "행위 유형 (CREATE, UPDATE, DELETE)"]
  before_data jsonb [note: "변경 전 데이터"]
  after_data jsonb [note: "변경 후 데이터"]
  actor_user_id uuid [note: "행위자 사용자 ID"]
  ip_address varchar(45) [note: "요청 IP"]
  created_at timestamp [not null, default: `now()`, note: "행위 시점"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
}

Table notification {
  id uuid [pk, not null, note: "알림 ID"]
  user_id uuid [not null, note: "수신 사용자 ID"]
  type_category_code varchar(40) [not null, default: 'notification_type', note: "알림 타입 분류"]
  type varchar(40) [not null, note: "알림 타입 코드 (COMMENT, REPLY, SYSTEM 등)"]
  message text [not null, note: "알림 메시지"]
  link text [note: "이동 링크"]
  is_read boolean [not null, default: false, note: "읽음 여부"]
  created_at timestamp [not null, default: `now()`, note: "생성일"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
  read_at timestamp [note: "읽은 시점"]
}

Table comment {
  id uuid [pk, not null, note: "댓글 ID"]
  topic_id uuid [not null, note: "게시글 ID"]
  user_id uuid [not null, note: "작성자 사용자 ID"]
  upper_comment_id uuid [note: "상위 댓글 ID"]
  content text [not null, note: "댓글 내용"]
  is_deleted boolean [not null, default: false, note: "삭제 여부"]
  created_at timestamp [not null, default: `now()`, note: "작성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
}

Table tag {
  id uuid [pk, not null, note: "태그 ID"]
  name varchar(50) [not null, unique, note: "태그 명"]
  description text [note: "태그 설명"]
  created_at timestamp [not null, default: `now()`, note: "생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]
}

Table rel__topic_tag {
  id uuid [pk, not null, note: "게시글-태그 연결 ID"]
  topic_id uuid [not null, note: "게시글 ID"]
  tag_id uuid [not null, note: "태그 ID"]
  created_at timestamp [not null, default: `now()`, note: "연결 생성일시"]
  updated_at timestamp [not null, default: `now()`, note: "수정일시"]
  deleted_at timestamp [note: "삭제일시"]

  indexes {
    (topic_id, tag_id) [unique]
  }
}

/* Relations */
Ref: code.category_code > code_category.code
Ref: code.upper_category_code > code_category.code
Ref: code.(upper_category_code, upper_code) > code.(category_code, code)

Ref: board.menu_code > menu.code
Ref: board.type_category_code > code_category.code
Ref: board.(type_category_code, type) > code.(category_code, code)

Ref: topic.author_user_id > user.id
Ref: topic.board_id > board.id
Ref: topic.menu_code > menu.code
Ref: topic.status_category_code > code_category.code
Ref: topic.(status_category_code, status) > code.(category_code, code)

Ref: comment.topic_id > topic.id
Ref: comment.user_id > user.id
Ref: comment.upper_comment_id > comment.id

Ref: rel__topic_file.topic_id > topic.id
Ref: rel__topic_file.file_id > common_file.id

Ref: rel__user_file.user_id > user.id
Ref: rel__user_file.file_id > common_file.id

Ref: rel__topic_tag.topic_id > topic.id
Ref: rel__topic_tag.tag_id > tag.id

Ref: menu.upper_code > menu.code

Ref: user.role_category_code > code_category.code
Ref: user.(role_category_code, role) > code.(category_code, code)

Ref: user_auth_count.user_id > user.id
Ref: user_auth_count.type_category_code > code_category.code
Ref: user_auth_count.(type_category_code, type) > code.(category_code, code)

Ref: verification.user_id > user.id
Ref: verification.type_category_code > code_category.code
Ref: verification.(type_category_code, type) > code.(category_code, code)

Ref: user_session.user_id > user.id

Ref: audit_log.actor_user_id > user.id

Ref: notification.user_id > user.id
Ref: notification.type_category_code > code_category.code
Ref: notification.(type_category_code, type) > code.(category_code, code)